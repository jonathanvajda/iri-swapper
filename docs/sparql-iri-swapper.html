<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="./images/block-logo.png">
  <title>Myna SPARQL IRI Swapper</title>

  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- Local vendored imports only -->
  <link rel="stylesheet" href="./styles/skeleton.css">
  <link rel="stylesheet" href="./styles/tabulator.min.css">

  <!-- App Global CSS -->
  <script>
    (function () {
      const APPBASE_CSS_SOURCES = [
        /*"./styles/app-base.css",  local dev copy first */
        "https://jonathanvajda.github.io/OntoEagle/styles/app-base.css",
        "https://jonathanvajda.github.io/table-nova/styles/app-base.css",
      ];

      function loadCss(href) {
        return new Promise((resolve, reject) => {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = href;

          link.onload = () => resolve(href);
          link.onerror = () => reject(new Error("CSS failed: " + href));

          document.head.appendChild(link);
        });
      }

      function showFailure(msg) {
        console.error(msg);
        // Optional user-visible banner
        const style = document.createElement("style");
        style.textContent =
          ".asset-fail-banner{position:fixed;left:0;right:0;top:0;z-index:9999;" +
          "padding:.5rem .75rem;font:14px system-ui;background:#ffe8e8;color:#400;" +
          "border-bottom:1px solid rgba(0,0,0,.2)}";
        document.head.appendChild(style);

        const div = document.createElement("div");
        div.className = "asset-fail-banner";
        div.textContent = msg;
        document.body ? document.body.prepend(div) : document.addEventListener("DOMContentLoaded", () => document.body.prepend(div));
      }

      (async () => {
        for (const href of APPBASE_CSS_SOURCES) {
          try { await loadCss(href); return; } catch (_) {}
        }
        showFailure("Failed to load app base CSS from all sources.");
      })();
    })();
  </script>
  <script>
    (function () {
      const HEADER_CSS_SOURCES = [
        /*"./styles/site-header.css",  local dev copy first */
        "https://jonathanvajda.github.io/OntoEagle/styles/site-header.css",
        "https://jonathanvajda.github.io/table-nova/styles/site-header.css",
      ];

      function loadCss(href) {
        return new Promise((resolve, reject) => {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = href;

          link.onload = () => resolve(href);
          link.onerror = () => reject(new Error("CSS failed: " + href));

          document.head.appendChild(link);
        });
      }

      function showFailure(msg) {
        console.error(msg);
        // Optional user-visible banner
        const style = document.createElement("style");
        style.textContent =
          ".asset-fail-banner{position:fixed;left:0;right:0;top:0;z-index:9999;" +
          "padding:.5rem .75rem;font:14px system-ui;background:#ffe8e8;color:#400;" +
          "border-bottom:1px solid rgba(0,0,0,.2)}";
        document.head.appendChild(style);

        const div = document.createElement("div");
        div.className = "asset-fail-banner";
        div.textContent = msg;
        document.body ? document.body.prepend(div) : document.addEventListener("DOMContentLoaded", () => document.body.prepend(div));
      }

      (async () => {
        for (const href of HEADER_CSS_SOURCES) {
          try { await loadCss(href); return; } catch (_) {}
        }
        showFailure("Failed to load header CSS from all sources.");
      })();
    })();
  </script>
  <link rel="stylesheet" href="./styles/iri-swapper.css" />
</head>

<body data-page-id="myna-sparql-iri-swapper">
  <header id="siteHeader" class="sitehdr-root" role="banner" aria-label="Site header"></header>

  <div id="mb-app" class="mb-app">
    <section class="mb-grid">
      <div class="mb-card">
        <h2 class="mb-h2">1) Load SPARQL query</h2>
        <p class="mb-muted">Drop a <code>.rq</code> or <code>.sparql</code> file. We extract PREFIX/BASE and stage IRIs used in the query.</p>

        <div class="mb-row">
          <div class="mb-dropzone" id="queryDrop">
            <div class="mb-dropTitle">Drop SPARQL query here</div>
            <div class="mb-dropHint">…or choose a file</div>
            <input id="queryFile" type="file" accept=".rq,.sparql" />
          </div>

          <div class="mb-panel">
            <label class="mb-check">
              <input id="useNativePrefixes" type="checkbox" checked />
              Use query’s native prefixes in output (default on)
            </label>

            <div class="mb-mini">
              <div><strong>Run ID:</strong> <span id="queryRunId">—</span></div>
              <div><strong>Detected BASE:</strong> <span id="baseIri">—</span></div>
            </div>
          </div>
        </div>

        <details class="mb-details">
          <summary>Prefixes (JSON)</summary>
          <pre id="prefixJson" class="mb-pre">{}</pre>
        </details>

        <div class="mb-actions">
          <button id="ingestQueryBtn" class="mb-btn" type="button">Ingest query</button>
        </div>
      </div>

      <div class="mb-card">
        <h2 class="mb-h2">2) Load mapping file</h2>
        <p class="mb-muted">CSV/TSV/XLS/XLSX with headers: <code>Old IRI</code>, <code>New IRI</code>.</p>

        <div class="mb-row">
          <div class="mb-dropzone" id="mappingDrop">
            <div class="mb-dropTitle">Drop mapping file here</div>
            <div class="mb-dropHint">…or choose a file</div>
            <input id="mappingFile" type="file" accept=".csv,.tsv,.xls,.xlsx" />
          </div>

          <div class="mb-panel">
            <div class="mb-mini">
              <div><strong>Mapping rows:</strong> <span id="mappingRows">0</span></div>
              <div><strong>Unique “Old IRI”:</strong> <span id="mappingUniqueOld">0</span></div>
              <div><strong>Duplicates (Old IRI):</strong> <span id="mappingDupOld">0</span></div>
            </div>

            <div class="mb-actions">
              <button id="ingestMappingBtn" class="mb-btn mb-btnSecondary" type="button">Ingest mapping</button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-card mb-cardWide">
        <h2 class="mb-h2">3) Preview staged changes</h2>

        <div class="mb-kpis">
          <div class="mb-kpi">
            <div class="mb-kpiLabel">Unique IRIs/tokens staged</div>
            <div class="mb-kpiValue" id="kpiTokens">0</div>
          </div>
          <div class="mb-kpi">
            <div class="mb-kpiLabel">Mapping IRIs (unique old)</div>
            <div class="mb-kpiValue" id="kpiMapping">0</div>
          </div>
          <div class="mb-kpi">
            <div class="mb-kpiLabel">Changes proposed</div>
            <div class="mb-kpiValue" id="kpiProposed">0</div>
          </div>
          <div class="mb-kpi">
            <div class="mb-kpiLabel">% staged changed</div>
            <div class="mb-kpiValue" id="kpiPct">0%</div>
          </div>
        </div>

        <div class="mb-actions">
          <button id="buildPreviewBtn" class="mb-btn" type="button">Build preview table</button>
          <button id="applyMappingBtn" class="mb-btn mb-btnDanger" type="button">Apply mapping → create output run</button>
        </div>

        <div id="table" class="mb-table"></div>

        <div class="mb-runbar">
          <div class="mb-runbarLeft">
            <label class="mb-label" for="runsSelect">Runs (IndexedDB)</label>
            <select id="runsSelect" class="mb-select"></select>
            <button id="loadRunBtn" class="mb-btn mb-btnSecondary" type="button">Load run</button>
            <button id="deleteRunBtn" class="mb-btn mb-btnSecondary" type="button">Delete run</button>
            <button id="clearRunsBtn" class="mb-btn mb-btnSecondary" type="button">Clear all</button>
          </div>

          <div class="mb-runbarRight">
            <button id="downloadBtn" class="mb-btn" type="button">Download output (.rq)</button>
          </div>
        </div>

        <details class="mb-details" open>
          <summary>Output preview</summary>
          <textarea id="outputPreview" class="mb-textarea" spellcheck="false"></textarea>
        </details>

        <div class="mb-status" id="status" aria-live="polite"></div>
      </div>
    </section>

    <footer class="mb-footer">
      <div class="mb-muted">Offline works on <code>https://</code> or <code>http://localhost</code>.</div>
    </footer>
  </div>

  <!-- Local vendored imports only -->
  <script src="./app/tabulator.min.js"></script>
  <script src="./app/papaparse.min.js"></script>
  <script src="./app/xlsx.full.min.js"></script>

  <!-- Header -->
  <script>
    (function () {
      const JS_SOURCES = [
        /* "./app/site-header.js", local dev copy first */
        "https://jonathanvajda.github.io/OntoEagle/app/site-header.js",
        "https://jonathanvajda.github.io/table-nova/app/site-header.js",
      ];

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.defer = true;

          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("JS failed: " + src));

          document.head.appendChild(s);
        });
      }

      function showFailure(msg) {
        console.error(msg);
        const div = document.createElement("div");
        div.style.cssText =
          "position:fixed;left:0;right:0;bottom:0;z-index:9999;" +
          "padding:.5rem .75rem;font:14px system-ui;background:#ffe8e8;color:#400;" +
          "border-top:1px solid rgba(0,0,0,.2)";
        div.textContent = msg;
        document.body ? document.body.appendChild(div) : document.addEventListener("DOMContentLoaded", () => document.body.appendChild(div));
      }

      (async () => {
        for (const src of JS_SOURCES) {
          try { await loadScript(src); return; } catch (_) {}
        }
        showFailure("Failed to load header JavaScript from all sources.");
      })();
    })();
  </script>

  <!-- New JS (does not touch your existing app.js) -->
  <script type="module" src="./app/sparql-iri-swapper.js"></script>
</body>
</html>
